<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choropleth Map of US Drought Data</title>
    <link rel="stylesheet" href="https://unpkg.com/mapbox-gl/dist/mapbox-gl.css" />
    <style>
        #map { height: 600px; }
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        .legend div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend div span {
            margin-left: 10px;
        }
    </style>
    <script src="https://unpkg.com/mapbox-gl/dist/mapbox-gl.js"></script>
</head>
<body>
    <h1>US Current Drought Map</h1>
    <div id="map"></div>
    <div class="legend">
        <div><span style="background-color: #31a354; width: 20px; height: 20px; display: inline-block;"></span><span>No Drought</span></div>
        <div><span style="background-color: #66c2a4; width: 20px; height: 20px; display: inline-block;"></span><span>Abnormally Dry</span></div>
        <div><span style="background-color: #99d8c9; width: 20px; height: 20px; display: inline-block;"></span><span>Moderate Drought</span></div>
        <div><span style="background-color: #fc8d59; width: 20px; height: 20px; display: inline-block;"></span><span>Severe Drought</span></div>
        <div><span style="background-color: #d7301f; width: 20px; height: 20px; display: inline-block;"></span><span>Extreme Drought</span></div>
    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2FsbGFoYWkiLCJhIjoiY204Z2Y2b3dwMDFxejJrb2NncTRqNWo4eSJ9.SWOSp9Q1_IHaFeoOtafDhQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'https://raw.githubusercontent.com/aidcallahan/lab4/main/style.json',
            center: [-96, 37.8],
            zoom: 4
        });
        map.on('load', function() {
            fetch('https://raw.githubusercontent.com/aidcallahan/lab3/main/usdm_current.json')
                .then(response => {
                    if (!response.ok) {
                        console.error("Failed to fetch GeoJSON data. Status: " + response.status);
                        return Promise.reject("GeoJSON fetch failed");
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data) {
                        const filteredData = {
                            type: "FeatureCollection",
                            features: data.features.filter(feature => feature.properties.DM !== undefined && feature.properties.DM !== null)
                        };

                        map.addSource('drought-data', {
                            type: 'geojson',
                            data: filteredData
                        });

                        map.addLayer({
                            id: 'drought-layer',
                            type: 'fill',
                            source: 'drought-data',
                            paint: {
                                'fill-color': [
                                    'match',
                                    ['get', 'DM'],
                                    0, '#31a354',
                                    1, '#66c2a4',
                                    2, '#99d8c9',
                                    3, '#fc8d59',
                                    4, '#d7301f',
                                    '#ffffff'
                                ],
                                'fill-opacity': 0.7
                            }
                        }, 'sky');
                        map.on('mouseenter', 'drought-layer', function() {
                            map.getCanvas().style.cursor = 'pointer';
                        });

                        map.on('mouseleave', 'drought-layer', function() {
                            map.getCanvas().style.cursor = '';
                        });
                        map.on('click', 'drought-layer', function(e) {
                            var properties = e.features[0].properties;
                            var popupContent = `
                                <strong>${properties.name || 'Unknown Area'}</strong><br>
                                Drought Severity: ${getDroughtLevel(properties.DM)}
                            `;
                            new mapboxgl.Popup()
                                .setLngLat(e.lngLat)
                                .setHTML(popupContent)
                                .addTo(map);
                        });
                    } else {
                        console.error("No data available to load.");
                    }
                })
                .catch(error => {
                    console.error("Error loading GeoJSON data:", error);
                });
        });

        function getDroughtLevel(droughtIntensity) {
            switch (droughtIntensity) {
                case 0: return "No Drought";
                case 1: return "Abnormally Dry";
                case 2: return "Moderate Drought";
                case 3: return "Severe Drought";
                case 4: return "Extreme Drought";
                default: return "Unknown";
            }
        }
    </script>
</body>
</html>
